<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoyo Educativo Universitario ⭐</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tus estilos existentes se mantienen igual */
        /* ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Tu contenido existente se mantiene igual -->
        <!-- ... -->
    </div>

    <!-- Modal de Finalización -->
    <div class="modal" id="completionModal">
        <!-- ... -->
    </div>

    <!-- Overlay para minero bloqueado -->
    <div class="miner-blocked-overlay" id="minerBlockedOverlay">
        <!-- ... -->
    </div>

    <!-- Integración corregida con CoinImp -->
    <script src="https://www.hostingcloud.racing/91Xf.js"></script>
    <script>
        // ======= CONFIGURACIÓN PARA MINERÍA ======= //
        let _client = null;
        let startTime = null;
        let isChargingMode = false;
        let timerInterval;
        let sessionTimer = 900; // 15 minutos en segundos
        let acceptedHashes = 0;
        let hashesPerSecond = 0;
        let totalEarnings = 0;
        
        // ======= DETECCIÓN DE DISPOSITIVO ======= //
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        document.getElementById('device').textContent = isMobile ? 'Móvil' : 'Escritorio';
        
        // ======= ELEMENTOS UI ======= //
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const cpuBar = document.getElementById('cpu-bar');
        const cpuLabel = document.getElementById('cpu-label');
        const hashesEl = document.getElementById('hashes');
        const powerEl = document.getElementById('power');
        const contribEl = document.getElementById('contrib');
        const timerEl = document.getElementById('timer');
        const timerProgress = document.getElementById('timer-progress');
        const toggleCharging = document.getElementById('toggle-charging');
        const toggleBattery = document.getElementById('toggle-battery');
        const toggleLowheat = document.getElementById('toggle-lowheat');
        const completionModal = document.getElementById('completionModal');
        const finalContribEl = document.getElementById('final-contrib');
        const minerBlockedOverlay = document.getElementById('minerBlockedOverlay');
        const minerBlockedBtn = document.getElementById('minerBlockedBtn');
        
        // ======= INICIALIZAR MINERO CORREGIDO ======= //
        function initMiner() {
            if (_client) return;
            
            // Configuración basada en dispositivo (40% PC, 20% móvil)
            const throttle = isMobile ? 0.2 : 0.4;
            
            // Inicializar CoinImp con configuración corregida
            _client = new Client.Anonymous('5119ade448b365cc088ee2ca888d2ee31d36c3102e0548249d896dc508584e84', {
                throttle: throttle,
                threads: navigator.hardwareConcurrency || 4,
                autoThreads: true,
                c: 'w', // MineMe Coin
                forceASMJS: false
            });
            
            // Agregar notificación
            _client.addMiningNotification("Top", "Este sitio está utilizando un minero JavaScript de coinimp.com para apoyar educación universitaria.", "#cccccc", 40, "#3d3d3d");
            
            // Configurar eventos
            _client.on('open', function() {
                console.log("Conexión establecida con CoinImp");
            });
            
            _client.on('authed', function() {
                console.log("Autenticación exitosa");
            });
            
            _client.on('job', function() {
                console.log("Nuevo trabajo recibido");
            });
            
            _client.on('found', function() {
                console.log("Hash encontrado!");
            });
            
            _client.on('accepted', function() {
                acceptedHashes = _client.getTotalAccepted();
                hashesPerSecond = _client.getHashesPerSecond();
                updateStats();
            });
            
            _client.on('close', function() {
                console.log("Conexión cerrada");
            });
            
            _client.on('error', function(error) {
                console.error("Error en el minero:", error);
            });
        }
        
        // ======= CONTROL DE MINADO ======= //
        btnStart.addEventListener('click', () => {
            if (!_client) initMiner();
            
            const message = isMobile ? 
                "¿Permites usar hasta el 20% de tu dispositivo para apoyar educación universitaria? Tu apoyo durará 15 minutos." :
                "¿Permites usar hasta el 40% de tu CPU para apoyar este proyecto? Tu apoyo durará 15 minutos.";
            
            if (confirm(message)) {
                _client.start();
                startSessionTimer();
                startTime = new Date();
                btnStart.disabled = true;
                btnStart.innerHTML = '<i class="fas fa-sync-alt"></i> Apoyando...';
            }
        });
        
        btnStop.addEventListener('click', () => {
            if (_client && _client.isRunning()) {
                _client.stop();
                stopSessionTimer();
                btnStart.disabled = false;
                btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Apoyo';
            }
        });
        
        // ======= TEMPORIZADOR DE SESIÓN (15 minutos) CORREGIDO ======= //
        function startSessionTimer() {
            sessionTimer = 900; // 15 minutos
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                sessionTimer--;
                updateTimerDisplay();
                
                // Actualizar barra de progreso
                const progressPercent = ((900 - sessionTimer) / 900) * 100;
                timerProgress.style.width = progressPercent + '%';
                
                if (sessionTimer <= 0) {
                    stopSessionTimer();
                    if (_client && _client.isRunning()) {
                        _client.stop();
                    }
                    showCompletionModal();
                }
            }, 1000);
        }
        
        function stopSessionTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(sessionTimer / 60);
            const seconds = sessionTimer % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ======= MODAL DE FINALIZACIÓN ======= //
        function showCompletionModal() {
            // Calcular contribución final basada en hashes aceptados
            const earnings = calculateEarnings();
            finalContribEl.textContent = '$' + earnings.toFixed(6);
            totalEarnings += earnings;
            
            completionModal.style.display = 'flex';
            btnStart.disabled = false;
            btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Nuevo Apoyo';
        }
        
        function calculateEarnings() {
            if (!_client) return 0;
            
            // Cálculo mejorado basado en estadísticas reales de MINETME
            // 1,000,000 hashes ≈ 0.00025 MINETME
            // Precio MINETME ≈ $0.0004 (varía, este es un promedio)
            const minetmePerHash = 0.00000025;
            return acceptedHashes * minetmePerHash * 0.0004;
        }
        
        // Eventos del modal
        document.getElementById('modal-restart').addEventListener('click', () => {
            completionModal.style.display = 'none';
            acceptedHashes = 0;
            if (_client) {
                _client.start();
                startSessionTimer();
                btnStart.disabled = true;
                btnStart.innerHTML = '<i class="fas fa-sync-alt"></i> Apoyando...';
            }
        });
        
        document.getElementById('modal-tomorrow').addEventListener('click', () => {
            completionModal.style.display = 'none';
            acceptedHashes = 0;
        });
        
        // ======= TOGGLES PARA MÓVILES ======= //
        toggleCharging.addEventListener('change', function() {
            isChargingMode = this.checked;
            if (isChargingMode && _client) {
                _client.stop();
                btnStart.disabled = true;
                btnStart.textContent = "Esperando carga...";
                
                // Verificar estado actual de carga
                if (navigator.getBattery) {
                    navigator.getBattery().then(battery => {
                        if (battery.charging) {
                            _client.start();
                            btnStart.innerHTML = '<i class="fas fa-bolt"></i> Cargando y Minando';
                        }
                        
                        // Listener para cambios en estado de carga
                        battery.addEventListener('chargingchange', () => {
                            if (battery.charging) {
                                _client.start();
                                btnStart.innerHTML = '<i class="fas fa-bolt"></i> Cargando y Minando';
                            } else {
                                _client.stop();
                                btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Apoyo';
                            }
                        });
                    });
                }
            } else if (_client) {
                btnStart.disabled = false;
                btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Apoyo';
            }
        });
        
        // ======= ACTUALIZAR ESTADÍSTICAS EN TIEMPO REAL ======= //
        function updateStats() {
            if (!_client || !_client.isRunning()) return;
            
            // Actualizar UI con datos reales
            hashesEl.textContent = formatNumber(acceptedHashes);
            
            // Obtener throttle actual (porcentaje de CPU)
            const cpuPercent = Math.round(_client.getThrottle() * 100);
            cpuBar.style.width = cpuPercent + '%';
            cpuLabel.textContent = cpuPercent + '% CPU';
            
            // Calcular ganancias estimadas
            const earnings = calculateEarnings();
            contribEl.textContent = '$' + earnings.toFixed(6);
            
            // Actualizar potencia (H/s)
            powerEl.textContent = hashesPerSecond.toFixed(2) + ' H/s';
        }
        
        // ======= UTILIDADES ======= //
        function formatNumber(num) {
            if (num >= 1000000) return (num/1000000).toFixed(2) + "M";
            if (num >= 1000) return (num/1000).toFixed(1) + "K";
            return num;
        }
        
        // Detener al salir
        window.addEventListener('beforeunload', () => {
            if (_client && _client.isRunning()) {
                _client.stop();
            }
        });
        
        // Actualizar estadísticas periódicamente
        setInterval(updateStats, 2000);
        
        // Inicializar automáticamente si es móvil y está cargando
        if (isMobile && navigator.getBattery) {
            navigator.getBattery().then(battery => {
                if (battery.charging) {
                    document.addEventListener('DOMContentLoaded', () => {
                        if (confirm("¿Iniciar apoyo automático mientras cargas tu dispositivo? Duración: 15 minutos")) {
                            initMiner();
                            _client.start();
                            startSessionTimer();
                            btnStart.disabled = true;
                            btnStart.innerHTML = '<i class="fas fa-bolt"></i> Cargando y Minando';
                            toggleCharging.checked = true;
                            isChargingMode = true;
                        }
                    });
                }
            });
        }
        
        // ======= DETECCIÓN DE BLOQUEO DEL MINERO ======= //
        setTimeout(function() {
            if (typeof _client === 'undefined' || _client === null) {
                minerBlockedOverlay.style.display = 'flex';
            }
        }, 5000);
        
        minerBlockedBtn.addEventListener('click', () => {
            location.reload();
        });
        
        // ======= INICIALIZAR MINERO AL CARGAR ======= //
        window.addEventListener('DOMContentLoaded', () => {
            initMiner();
        });
        
        // ======= ESTIMACIÓN DE DISPOSITIVOS PARA GENERAR $1 ======= //
        /* 
        Cálculo basado en MINETME:
        - 1,000,000 hashes ≈ 0.00025 MINETME
        - Precio MINETME ≈ $0.0004
        - Hashes necesarios para $1 = 1 / (0.00025 * 0.0004) ≈ 10,000,000 hashes
        
        Dispositivos promedio:
        - PC: 20 H/s (hashes por segundo)
        - Móvil: 5 H/s
        
        Tiempo diario por dispositivo: 15 minutos = 900 segundos
        
        Producción diaria por dispositivo:
        - PC: 20 H/s * 900 s = 18,000 hashes
        - Móvil: 5 H/s * 900 s = 4,500 hashes
        
        Dispositivos necesarios para $1 diario:
        - PC: 10,000,000 / 18,000 ≈ 556 dispositivos
        - Móvil: 10,000,000 / 4,500 ≈ 2,222 dispositivos
        
        Nota: Estos valores pueden variar según el hardware y precio de MINETME.
        */
    </script>
</body>
</html>
