<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoyo Educativo Universitario ⭐</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tus estilos CSS originales se mantienen aquí */
        /* ... (todo el CSS original permanece igual) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Todo el contenido HTML original se mantiene igual -->
        <!-- ... (todo el HTML original permanece igual) ... -->
    </div>

    <!-- Modal de Finalización -->
    <div class="modal" id="completionModal">
        <!-- ... (contenido del modal permanece igual) ... -->
    </div>

    <!-- Overlay para minero bloqueado -->
    <div class="miner-blocked-overlay" id="minerBlockedOverlay">
        <!-- ... (contenido permanece igual) ... -->
    </div>

    <!-- Integración con CoinImp - VERSIÓN CORREGIDA -->
    <script src="https://www.hostingcloud.racing/91Xf.js"></script>
    
    <script>
        // ======= CONFIGURACIÓN PARA MINERÍA ======= //
        let _client = null;
        let startTime = null;
        let isChargingMode = false;
        let timerInterval;
        let sessionTimer = 900; // 15 minutos en segundos
        let acceptedHashes = 0;
        let hashesPerSecond = 0;
        
        // ======= DETECCIÓN DE DISPOSITIVO ======= //
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        document.getElementById('device').textContent = isMobile ? 'Móvil' : 'Escritorio';
        
        // ======= ELEMENTOS UI ======= //
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const cpuBar = document.getElementById('cpu-bar');
        const cpuLabel = document.getElementById('cpu-label');
        const hashesEl = document.getElementById('hashes');
        const powerEl = document.getElementById('power');
        const contribEl = document.getElementById('contrib');
        const timerEl = document.getElementById('timer');
        const timerProgress = document.getElementById('timer-progress');
        const toggleCharging = document.getElementById('toggle-charging');
        const toggleBattery = document.getElementById('toggle-battery');
        const toggleLowheat = document.getElementById('toggle-lowheat');
        const completionModal = document.getElementById('completionModal');
        const finalContribEl = document.getElementById('final-contrib');
        const minerBlockedOverlay = document.getElementById('minerBlockedOverlay');
        const minerBlockedBtn = document.getElementById('minerBlockedBtn');
        
        // ======= INICIALIZAR MINERO ======= //
        function initMiner() {
            if (_client) return;
            
            // Configuración basada en dispositivo
            const throttle = isMobile ? 0.1 : 0.2;
            
            // CORRECCIÓN: Usar el sitio key correcto de CoinImp
            _client = new Client.Anonymous('5119ade448b365cc088ee2ca888d2ee31d36c3102e0548249d896dc508584e84', {
                throttle: throttle,
                threads: isMobile ? 1 : navigator.hardwareConcurrency || 2,
                autoThreads: false,
                c: 'w'
            });
            
            // Agregar notificación
            _client.addMiningNotification("Top", "Este sitio está utilizando un minero JavaScript de coinimp.com. Si te molesta, puedes detenerlo.", "#cccccc", 40, "#3d3d3d");
            
            // CORRECCIÓN: Configurar eventos para actualizar estadísticas
            _client.on('open', () => console.log("Conexión establecida con CoinImp"));
            _client.on('authed', (params) => console.log("Autenticado con el pool"));
            _client.on('job', (params) => console.log("Nuevo trabajo recibido"));
            _client.on('found', () => console.log("Hash válido encontrado"));
            _client.on('accepted', (params) => {
                acceptedHashes++;
                hashesPerSecond = _client.getHashesPerSecond();
                updateStats();
            });
            _client.on('close', () => console.log("Conexión cerrada"));
            _client.on('error', (error) => console.error("Error en el minero:", error));
        }
        
        // ======= CONTROL DE MINADO ======= //
        btnStart.addEventListener('click', () => {
            if (!_client) initMiner();
            
            const message = isMobile ? 
                "¿Permites usar hasta el 10% de tu dispositivo para apoyar educación universitaria? Tu apoyo durará 15 minutos." :
                "¿Permites usar hasta el 20% de tu CPU para apoyar este proyecto? Tu apoyo durará 15 minutos.";
            
            if (confirm(message)) {
                // CORRECCIÓN: Reiniciar estadísticas al comenzar nueva sesión
                acceptedHashes = 0;
                hashesPerSecond = 0;
                updateStats();
                
                _client.start();
                startSessionTimer();
                startTime = new Date();
                btnStart.disabled = true;
                btnStart.innerHTML = '<i class="fas fa-sync-alt"></i> Apoyando...';
            }
        });
        
        btnStop.addEventListener('click', () => {
            if (_client && _client.isRunning()) {
                _client.stop();
                stopSessionTimer();
                btnStart.disabled = false;
                btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Apoyo';
            }
        });
        
        // ======= TEMPORIZADOR DE SESIÓN (15 minutos) ======= //
        function startSessionTimer() {
            sessionTimer = 900; // 15 minutos
            updateTimerDisplay();
            timerProgress.style.width = '0%';
            
            timerInterval = setInterval(() => {
                sessionTimer--;
                updateTimerDisplay();
                
                // Actualizar barra de progreso
                const progressPercent = ((900 - sessionTimer) / 900) * 100;
                timerProgress.style.width = progressPercent + '%';
                
                if (sessionTimer <= 0) {
                    stopSessionTimer();
                    if (_client && _client.isRunning()) _client.stop();
                    showCompletionModal();
                }
            }, 1000);
        }
        
        function stopSessionTimer() {
            clearInterval(timerInterval);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(sessionTimer / 60);
            const seconds = sessionTimer % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ======= MODAL DE FINALIZACIÓN ======= //
        function showCompletionModal() {
            // Calcular contribución final basada en hashes aceptados
            if (_client) {
                // CORRECCIÓN: Cálculo más preciso basado en estadísticas de CoinImp
                // Valor aproximado: 1 millón de hashes = 0.00025 XMR ≈ $0.03 USD
                const earnings = acceptedHashes * 0.00000003;
                finalContribEl.textContent = '$' + earnings.toFixed(4);
                
                // Actualizar contribución en el modal
                document.getElementById('final-contrib').textContent = '$' + earnings.toFixed(4);
            }
            
            completionModal.style.display = 'flex';
            btnStart.disabled = false;
            btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Nuevo Apoyo';
        }
        
        // Eventos del modal
        document.getElementById('modal-restart').addEventListener('click', () => {
            completionModal.style.display = 'none';
            if (_client) {
                _client.start();
                startSessionTimer();
                btnStart.disabled = true;
                btnStart.innerHTML = '<i class="fas fa-sync-alt"></i> Apoyando...';
            }
        });
        
        document.getElementById('modal-tomorrow').addEventListener('click', () => {
            completionModal.style.display = 'none';
        });
        
        // ======= TOGGLES PARA MÓVILES ======= //
        toggleCharging.addEventListener('change', function() {
            isChargingMode = this.checked;
            if (isChargingMode && _client) {
                _client.stop();
                btnStart.disabled = true;
                btnStart.textContent = "Esperando carga...";
                
                // Verificar estado actual de carga
                if (navigator.getBattery) {
                    navigator.getBattery().then(battery => {
                        if (battery.charging) {
                            _client.start();
                            btnStart.innerHTML = '<i class="fas fa-bolt"></i> Cargando y Minando';
                        }
                        
                        // Escuchar cambios en el estado de carga
                        battery.addEventListener('chargingchange', () => {
                            if (battery.charging) {
                                _client.start();
                                btnStart.innerHTML = '<i class="fas fa-bolt"></i> Cargando y Minando';
                            } else {
                                _client.stop();
                                btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Apoyo';
                                btnStart.disabled = false;
                            }
                        });
                    });
                }
            } else if (_client) {
                btnStart.disabled = false;
                btnStart.innerHTML = '<i class="fas fa-play-circle"></i> Iniciar Apoyo';
            }
        });
        
        // ======= ACTUALIZAR ESTADÍSTICAS ======= //
        function updateStats() {
            if (!_client || !_client.isRunning()) return;
            
            // Actualizar UI con datos reales
            hashesEl.textContent = formatNumber(acceptedHashes);
            
            // Calcular uso de CPU basado en throttle
            const cpuPercent = Math.round(_client.getThrottle() * 100);
            cpuBar.style.width = cpuPercent + '%';
            cpuLabel.textContent = cpuPercent + '% CPU';
            
            // Calcular potencia basada en hashes por segundo
            const powerEstimate = Math.min(100, Math.round(hashesPerSecond * (isMobile ? 0.5 : 0.1)));
            powerEl.textContent = powerEstimate + '%';
            
            // Calcular ganancias estimadas (basado en estadísticas reales de CoinImp)
            // Valor aproximado: 1 millón de hashes = 0.00025 XMR ≈ $0.03 USD
            const earnings = acceptedHashes * 0.00000003;
            contribEl.textContent = '$' + earnings.toFixed(6);
        }
        
        // ======= UTILIDADES ======= //
        function formatNumber(num) {
            if (num >= 1000000) return (num/1000000).toFixed(2) + "M";
            if (num >= 1000) return (num/1000).toFixed(1) + "K";
            return num;
        }
        
        // Detener al salir
        window.addEventListener('beforeunload', () => {
            if (_client && _client.isRunning()) _client.stop();
        });
        
        // Actualizar estadísticas periódicamente
        setInterval(updateStats, 1000);
        
        // Inicializar automáticamente si es móvil y está cargando
        if (isMobile && navigator.getBattery) {
            navigator.getBattery().then(battery => {
                if (battery.charging) {
                    document.addEventListener('DOMContentLoaded', () => {
                        if (confirm("¿Iniciar apoyo automático mientras cargas tu dispositivo? Duración: 15 minutos")) {
                            initMiner();
                            _client.start();
                            startSessionTimer();
                            btnStart.disabled = true;
                            btnStart.innerHTML = '<i class="fas fa-bolt"></i> Cargando y Minando';
                            toggleCharging.checked = true;
                            isChargingMode = true;
                        }
                    });
                }
            });
        }
        
        // ======= DETECCIÓN DE BLOQUEO DEL MINERO ======= //
        setTimeout(function() {
            if (typeof Client === 'undefined' || typeof _client === 'undefined' || _client === null) {
                minerBlockedOverlay.style.display = 'flex';
            }
        }, 3000);
        
        minerBlockedBtn.addEventListener('click', () => {
            location.reload();
        });
        
        // ======= INICIALIZAR MINERO AL CARGAR ======= //
        window.addEventListener('DOMContentLoaded', () => {
            initMiner();
        });
    </script>
</body>
</html>
